  <!--
            - PRODUCT GRID
          -->

          <div class="product-main ">

            <h2 class="title">Productos</h2>

            <div class="product-grid">

                {% for object in object_list %}
              <div class="showcase">

                <div class="showcase-banner">

                  <img src="{{ object.image.url }}" alt="{{ object.name }}" width="300" class="product-img default">
                  <img src="{{ object.image.url }}" alt="{{ object.name }}" width="300" class="product-img hover">

                    {% if object.offer %}
                  <p class="showcase-badge">{{ object.offer.descuento }}%</p>
                    {% endif %}

                  <div class="showcase-actions">

                     {% if request.user.usuario.rol.nombre == 'cliente' %}
    {% if request.user in object.usuarios_que_dieron_like %}
        <a href="#" id="like-btn-{{ object.pk }}" class="btn-action">
            <ion-icon name="heart-dislike-outline"></ion-icon>
        </a>
    {% else %}
        <a href="#" id="like-btn-{{ object.pk }}" class="btn-action">
            <ion-icon name="heart-outline"></ion-icon>
        </a>
    {% endif %}
{% endif %}
                  


                    <a  href="{% url 'products:detail' object.handle %}" class="btn-action">

                      <ion-icon name="eye-outline"></ion-icon>

                    </a>

{#                    <button class="btn-action">#}
{#                      <ion-icon name="repeat-outline"></ion-icon>#}
{#                    </button>#}
                    {% if not request.user.usuario.rol.nombre == 'Proveedor' %}
     <form id="add-to-cart-form" onsubmit="event.preventDefault(); addToCart({{ object.id }}, 1);">
        {% csrf_token %}
        <button type="submit" class="btn-action">
            <ion-icon name="bag-add-outline"></ion-icon>
        </button>
    </form>
                  {% endif %}

                  </div>

                </div>

                <div class="showcase-content">


                    {% if object.clasificacion.all %}

              {% for clasi in object.clasificacion.all|slice:":1" %}

                <a href="{% url 'products:list' %}?classification_id={{ clasi.id }}" class="showcase-category">{{ clasi.nombre }}</a>
                    {% endfor %}
                    {% else %}
                     {% if object.clasificaciones_padre %}


                                 <a href="{% url 'products:list' %}?classification_id_padre={{ object.clasificaciones_padre.id }}" class="showcase-category">{{ object.clasificaciones_padre.nombre }}</a>

                         {% endif %}
                  {% endif %}


                  <a href="{% url 'products:detail' object.handle %}">
                    <h3 class="showcase-title">{{ object.name }}</h3>
                  </a>

                  <div class="showcase-rating">
                          {% for i in "12345"|make_list %}
                              {% with j=i|add:-1 %}

                              {% if i|add:0  <= object.rating_product.average_rating %}
                        <ion-icon name="star"></ion-icon>



                              {% endif %}

                              {% if i|add:0  > object.rating_product.average_rating and j|add:0  < object.rating_product.average_rating  %}
                                      <ion-icon name="star-half"></ion-icon>  <!-- Estrella media -->
                        {% else %}

                                      {% endif %}

                             {% if i|add:0  >= object.rating_product.average_rating and j|add:0  >= object.rating_product.average_rating %}
                              <ion-icon name="star-outline"></ion-icon>
                                  {% endif %}
{% endwith %}
                              {% endfor %}


                      </div>

                  <div class="price-box">

                  <p class="price">${{ object.price }}</p>
    {% if object.offer %}
                  <del>${{ object.offer.precio_viejo }}</del>
                     {% endif %}
                </div>

                </div>

              </div>
                {% endfor %}








            </div>

          </div>

        </div>

      </div>

    </div>


<script>
        function addToCart(productId, quantity) {
    console.log("Este es el ID del producto: ", productId);
    console.log("La cantidad es: ", quantity);

    fetch(`/carro/agregar/${productId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ product_id: productId, quantity: quantity })
    })
    .then(response => {
        console.log("Estado de la respuesta:", response.status);
        if (response.ok) {
            return response.json();
        } else {
            return response.text().then(text => {
                throw new Error(`Error al agregar el producto: ${text}`);
            });
        }
    })
    .then(data => {
       const countElement = document.getElementById('cart-count1');
       const countElement2 = document.getElementById('cart-count2');
        const currentCount = parseInt(countElement.innerText, 10); // Obtener el conteo actual
        const currentCount2 = parseInt(countElement2.innerText, 10); // Obtener el conteo actual
        countElement.innerText = currentCount + 1; // Incrementar el contador
        countElement2.innerText = currentCount2 + 1; // Incrementar el contador
        alert(data.message); // Ahora muestra el mensaje del servidor
    })
    .catch(error => {
        console.error(error);
        alert('Hubo un problema al agregar el producto');
    });
}
        function getCookie(name) {
            const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return cookieValue ? cookieValue.pop() : '';
        }

        {#-------------------------------------- Like y dislike -------------------------------------------------#}



       document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('[id^="like-btn-"]');

    likeButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault(); // Evita el comportamiento por defecto del enlace
            const productId = this.id.split('-')[2]; // Obtiene el ID del producto
            const isLike = this.querySelector('ion-icon').getAttribute('name') === 'heart-outline'; // Determina si es like o dislike

            toggleLike(productId, isLike, this); // Pasa el botón actual
        });
    });
});

function toggleLike(productId, isLike, button) {
    const url = isLike ? `/like_product/${productId}/` : `/dislike_product/${productId}/`;
    const method = isLike ? 'POST' : 'DELETE'; // Cambia el método según corresponda

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.text().then(text => {
                throw new Error(`Error al ${isLike ? 'dar like' : 'quitar like'}: ${text}`);
            });
        }
    })
    .then(data => {
        // Actualiza el contador de gustados
        const likeCountElement = document.getElementById('like-count');
        let currentCount = parseInt(likeCountElement.innerText, 10); // Obtener el conteo actual

        likeCountElement.innerText = isLike ? currentCount + 1 : currentCount - 1; // Sumar o restar

        // Si tienes otro contador, actualízalo aquí
        const likeCountElement2 = document.getElementById('like-count2');
        let currentCount2 = parseInt(likeCountElement2.innerText, 10); // Obtener el conteo actual

        likeCountElement2.innerText = isLike ? currentCount2 + 1 : currentCount2 - 1; // Sumar o restar

        // Actualiza el icono
        const icon = button.querySelector('ion-icon');
        icon.setAttribute('name', isLike ? 'heart-dislike-outline' : 'heart-outline'); // Cambia el ícono

        // Muestra el mensaje del servidor
        alert(data.message);
    })
    .catch(error => {
        console.error(error);
        alert('Hubo un problema al actualizar los gustados');
    });
}
    </script>